@model HoiTroWebsite.Models.RoomImage

@{
    ViewBag.Title = "Index";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayoutPage.cshtml";
}

<button class="btn btn-success text-white" id="btnAdd">

    <a href="#" class="" data-toggle="modal" data-target="#modalImg">
        <i class="fa fa-plus" aria-hidden="true"></i>Tạo thêm
    </a>
</button>

<div class="row">
    <div class="col-lg-12">
        <table width="100%" class="table table-striped table-bordered table-hover myTable" id="dataTables-example">
            <thead>
                <tr>
                    <th>
                        @Html.DisplayName("STT")
                    </th>
                    <th>
                        @Html.DisplayName("Ảnh")
                    </th>
                    <th>
                        @Html.DisplayName("ID bài đăng")
                    </th>
                    <th>
                        @Html.DisplayName("Meta")
                    </th>
                    <th>
                        @Html.DisplayName("Hiển thị")
                    </th>
                    <th>
                        @Html.DisplayName("Sắp xếp")
                    </th>
                    <th>
                        @Html.DisplayName("Ngày tạo")
                    </th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="tbimg">
            </tbody>
        </table>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="modalImg" tabindex="-1" role="dialog" aria-labelledby="basicModal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">Basic Modal</h4>
            </div>
            <div class="modal-body">
                @*<h3>Modal Body</h3>*@
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                @*<button type="button" class="btn btn-primary">Save changes</button>*@
            </div>
        </div>
    </div>
</div>
@section Scripts
{
    <script>
        $(document).ready(function () {
            LoadImg();
        })
        // Create
        $('#btnAdd').click(function () {
            $.ajax({
                url: '/Admin/RoomImages/Create',
                type: 'get',
                success: function (data) {
                    //console.log(data);
                    $('#modalImg').find('.modal-body').html(data);
                },
            });
        })
        // Detail
        $(document).on('click', '.btnDetail', function () {
            var id = $(this).data('id');

            $.ajax({
                url: '/Admin/RoomImages/Details/' + id,
                type: 'get',
                success: function (data) {
                    $('#modalImg').find('.modal-body').html(data);
                },
                error: function (xhr, status, error) {
                    console.error('Lỗi:', error);
                }
            });
        });
        // Edit
        $(document).on('click', '.btnEdit', function () {
            var id = $(this).data('id');

            $.ajax({
                url: '/Admin/RoomImages/Edit/' + id,
                type: 'get',
                success: function (data) {
                    $('#modalImg').find('.modal-body').html(data);
                },
                error: function (xhr, status, error) {
                    console.error('Lỗi:', error);
                }
            });
        });
        // Delete
        $(document).on('click', '.btnDelete', function () {
            var id = $(this).data('id');

            $.ajax({
                url: '/Admin/RoomImages/Delete/' + id,
                type: 'get',
                success: function (data) {
                    $('#modalImg').find('.modal-body').html(data);
                },
                error: function (xhr, status, error) {
                    console.error('Lỗi:', error);
                }
            });
        });

        function LoadImg() {
            $.ajax({
                url: '/Admin/RoomImages/getImages',
                type: 'get',
                success: function (data) {
                    if (data.code == 200) {
                        $('#tbimg').empty();
                        $.each(data.img, function (k, v) {
                            //console.log(data.img)
                            const dateBegin = v.DateBegin === null ? '' : formatDate(v.DateBegin);

                            let tr = '<tr id="' + v.Id + '">'
                            tr += '<td>' + (k + 1) + '</td>';
                            tr += '<td><img src="/Content/images/' + v.Img + '"width ="50px" alt="' + v.Img + '"/></td>';
                            tr += '<td>' + v.Reference + '</td>';
                            tr += '<td>' + v.Meta + '</td>';
                            tr += '<td>' + v.Hide + '</td>';
                            tr += '<td>' + v.Order + '</td>';
                            tr += '<td>' + dateBegin + '</td>';
                            tr += '<td class="text-right">';
                            tr += '<button class="btn btn-xs btn-info btnDetail" data-id="' + v.Id + '"><i class="fa fa-info-circle" aria-hidden="true"></i><a href="#" class="" data-toggle="modal" data-target="#modalImg"> Chi tiết </button>';
                            tr += '<button class="btn btn-xs btn-warning btnEdit" data-id="' + v.Id + '"><i class="fa fa-pencil-square-o" aria-hidden="true"></i><a href="#" class="" data-toggle="modal" data-target="#modalImg"> Chỉnh sửa </button>';
                            tr += '<button class="btn btn-xs btn-danger btnDelete" data-id="' + v.Id + '"><i class="fa fa-trash" aria-hidden="true"></i><a href="#" class="" data-toggle="modal" data-target="#modalImg"> Xóa </button>';
                            tr += '</td>';
                            tr += '</tr>';
                            $('#tbimg').append(tr);
                        });
                        // Kiểm tra nếu DataTable đã được khởi tạo
                        if ($.fn.dataTable.isDataTable('#dataTables-example')) {
                            // Nếu đã khởi tạo, clear và redraw lại
                            var table = $('#dataTables-example').DataTable();
                            table.clear();
                            table.rows.add($('#tbimg').find('tr')); // Thêm các dòng mới từ tbody
                            table.draw();
                        } else {
                            // Nếu chưa khởi tạo DataTable, thì khởi tạo
                            $('#dataTables-example').DataTable({
                                "paging": true,
                                "searching": true,
                                "ordering": true
                            });
                        }

                        // Gắn lại các sự kiện cho các button sau khi tái khởi tạo DataTables
                        attachEventHandlers();
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Lỗi:', error);
                }
            });
        }
        // Hàm chuyển đổi định dạng ngày
        function formatDate(jsonDate) {
            // Trích xuất timestamp từ định dạng "/Date(1731171600000)/"
            const timestamp = parseInt(jsonDate.replace(/\/Date\((\d+)\)\//, '$1'));
            const date = new Date(timestamp);

            // Định dạng ngày mong muốn
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();

            return `${day}/${month}/${year}`;
        }

        // Submit create
        $(document).on('submit', '#form-create', function (e) {
            e.preventDefault();

            // Sử dụng FormData để xử lý file
            const formData = new FormData(this);

            $.ajax({
                url: '/Admin/RoomImages/Create',
                type: 'POST',
                data: formData,
                contentType: false, // Quan trọng để gửi file
                processData: false, // Quan trọng để gửi file
                success: function (response) {
                    if (response.code == 200) {
                        $('#modalImg').find('.close').click();
                        LoadImg();
                    } else {
                        console.error('Lỗi:', response.msg);
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Lỗi:', error);
                }
            });
        });

        // Submit edit
        $(document).on('submit', '#form-edit', function (e) {
            e.preventDefault();

            const form_data = new FormData(this);
            const id = $(this).find("input[name='id']").val();

            $.ajax({
                url: '/Admin/RoomImages/Edit/' + id,
                type: 'POST',
                data: form_data,
                contentType: false,
                processData: false,
                success: function (response) {
                    //console.log(response);
                    if (response.code === 200) {
                        $('#modalImg').find('.close').click();
                        LoadImg();
                    } else {
                        alert(response.msg);
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Lỗi:', error);
                    alert("Có lỗi xảy ra khi cập nhật img.");
                }
            });
        });

        // Submit delete
        $(document).on('submit', '#form-delete', function (e) {
            e.preventDefault();

            const id = $(this).find("input[name='id']").val(); // Lấy id từ trường ẩn trong form
            const token = $('input[name="__RequestVerificationToken"]').val(); // Lấy token chống giả mạo từ form

            $.ajax({
                url: '/Admin/RoomImages/DeleteConfirmed',
                type: 'POST',
                data: { id: id, __RequestVerificationToken: token },
                success: function (response) {
                    //console.log(response);
                    if (response.code == 200) {
                        $('#modalImg').find('.close').click();
                        LoadImg();
                    } else {
                        alert(response.msg);
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Lỗi:', error);
                    console.error('Mã trạng thái:', xhr.status);
                    console.error('Nội dung lỗi:', xhr.responseText);
                    alert("Có lỗi xảy ra khi xóa img. Vui lòng kiểm tra log lỗi.");
                }
            });
        });

    </script>

    <script>
        function previewImage(event) {
            var reader = new FileReader();
            reader.onload = function () {
                var output = document.getElementById('preview');
                output.src = reader.result;
            };
            reader.readAsDataURL(event.target.files[0]);
        }
    </script>
}
